---
title: "round_3_reliability"
author: "Drew Walker"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(irr)
library(janitor)
library(table1)
library(here)
library(gt)
```


```{r read-and-clean-data}
# User location: 
# Drew data cleaning
raw_annotation_data_dw <- read_csv("sample_location_sn_posts_revised_750.csv") %>% 
  clean_names()
dw_100_annotated <- raw_annotation_data_dw %>% 
  head(100) %>% 
mutate(source_drew = case_when(annotation_source %in% c("1","4") ~ 1,
                                 annotation_source %in% c("2","3")~ 0),
       user_drew = case_when(annotation_source %in% c("2","4")~1,
                                 annotation_source %in% c("1","3")~0))
#Drew Data clean
drew_data <- dw_100_annotated %>% 
  select(row_id_new,sentence,locations,source_drew,user_drew)
write_csv(drew_data, "100_sn_location_annotaion_drew_complete.csv")
drew_merge_data <- drew_data %>% 
  select(row_id_new,source_drew,user_drew)
# Sudeshna data clean
raw_annotation_data_sudeshna <- read_csv("100_sn_location_annotation_sudeshna_complete.csv") %>% 
  clean_names() %>% 
  rename(user_sudeshna = user_location,
         source_sudeshna = source_location) %>% 
  select(row_id_new,sentence,locations,source_sudeshna,user_sudeshna)

#combined_data_clean
combined_df_clean <- left_join(raw_annotation_data_sudeshna,drew_merge_data, by = "row_id_new")

combined_df_clean$location_list <- as.list(strsplit(combined_df_clean$locations,","))
length(combined_df_clean$location_list[[14]])
combined_df_clean2 <- combined_df_clean %>%
  group_by(row_id_new) %>% 
  mutate(multiple_locations = ifelse(map_int(location_list, length) > 1, 1, 0))



unnested_df_clean <- combined_df_clean2 %>% 
  unnest(location_list) 
# Need to create column for final score

single_locations <- unnested_df_clean %>% 
  filter(multiple_locations == 0)
# For agreements, make whatever Drew/Sudeshna said to carry forward agreements. 
# Add Adjudications

# For multiple locations: 
# 1. Grab df of multiple locations


multiple_locations <- unnested_df_clean %>% 
  filter(multiple_locations == 1)
# 2. Erase the original codes for these multiple to overwrite them 
multiple_locations$user_sudeshna <- ""
multiple_locations$source_sudeshna <- ""

multiple_locations$user_drew <- ""
multiple_locations$source_drew <- ""
# 2b. Number each sequential location to distinguish same country used twice
multiple_locations2 <- multiple_locations %>% 
  select(row_id_new,sentence,location_list,source_sudeshna,user_sudeshna,source_drew,user_drew,multiple_locations,locations) %>% 
  group_by(row_id_new) %>% 
  mutate(location_number = seq_along(location_list))
write_csv(multiple_locations2,"multiple_location_sn_annotation.csv", na = "")
# 3. Annotaion of the multiples at the location level for Drew + Sudeshna
# 4. Assess IR for multiple locations
# 5. Adjudicate 
# 6. Create gold standard final labels for multiple
# 7. Merge into gold standard final labels for single-- add these adjudications above 

# Additional labels

## Explode the 750 sentence sample by duplicating all elements in location list 
## Integrate gold label annotations for first 100
## Split remaining 500 between two sections-- Sudeshna = 250, me = 250 

# Run models
```

# Interrater kappas 


```{r create-users-data-and-kappa}
# Users df
users_sudeshna <- raw_annotation_data_sudeshna %>% 
  select(row_id_new,user_sudeshna)
users_drew <- drew_data %>% 
  select(row_id_new,user_drew)

#Join
combined_users <- left_join(users_sudeshna,users_drew, by = "row_id_new") %>% 
  select(user_drew,user_sudeshna)

user_location_kappa <- irr::kappa2(combined_users)
user_location_kappa

```

```{r create-source-location-data-and-kappa}
# Source location df
source_sudeshna <- raw_annotation_data_sudeshna %>% 
  select(row_id_new,source_sudeshna)
source_drew <- drew_data %>% 
  select(row_id_new,source_drew)

#Join
combined_locations <- left_join(source_sudeshna,source_drew, by = "row_id_new") %>% 
  select(source_drew,source_sudeshna)

source_location_kappa <- irr::kappa2(combined_locations)
source_location_kappa

```


# ID Disagreements 

```{r}
combined_location_user_df_clean <- combined_df_clean %>% 
  mutate(user_agree = case_when(user_drew==user_sudeshna~1, TRUE~0),
         source_agree = case_when(source_drew==source_sudeshna~1,TRUE~0))
table(combined_location_user_df_clean$user_agree) 
table(combined_location_user_df_clean$source_agree)

source_disagreements <- combined_location_user_df_clean %>% 
  filter(source_agree == 0)
gt(source_disagreements) %>% 
  tab_header("Source Disagreements")%>% 
  gtsave("Source_disagreements.html", inline_css = TRUE, 
         path = here())


user_disagreements <- combined_location_user_df_clean %>% 
  filter(user_agree == 0)
gt(user_disagreements) %>% 
  tab_header("User Disagreements")%>% 
  gtsave("user_disagreements.html", inline_css = TRUE, 
         path = here())

agreements <- combined_location_user_df_clean %>% 
  filter(user_agree == 1& source_agree ==1) %>% 
  mutate(source_location_label = source_drew,
         user_location_label = user_drew)


disagreements <- rbind(user_disagreements,source_disagreements) %>% 
  distinct(row_id_new, .keep_all = TRUE) %>% 
  mutate(source_location_label= "",
         user_location_label = "")
write_csv(disagreements, "disagreements_to_adjudicate.csv")


#adjudications <- read_csv("adjudications_sn_locations.csv")
```

# Adjudications


