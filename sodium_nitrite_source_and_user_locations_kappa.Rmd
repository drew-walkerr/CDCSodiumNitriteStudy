---
title: "round_3_reliability"
author: "Drew Walker"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(irr)
library(janitor)
library(table1)
library(here)
library(gt)
```


```{r read-and-clean-data}
# User location: 
# Drew data cleaning
raw_annotation_data_dw <- read_csv("sample_location_sn_posts_revised_750.csv") %>% 
  clean_names()
dw_100_annotated <- raw_annotation_data_dw %>% 
  head(100) %>% 
mutate(source_drew = case_when(annotation_source %in% c("1","4") ~ 1,
                                 annotation_source %in% c("2","3")~ 0),
       user_drew = case_when(annotation_source %in% c("2","4")~1,
                                 annotation_source %in% c("1","3")~0))
#Drew Data clean
drew_data <- dw_100_annotated %>% 
  select(row_id_new,sentence,locations,source_drew,user_drew)

drew_merge_data <- drew_data %>% 
  select(row_id_new,source_drew,user_drew)
# Sudeshna data clean
raw_annotation_data_sudeshna <- read_csv("100_sn_location_annotation_sudeshna_complete.csv") %>% 
  clean_names() %>% 
  rename(user_sudeshna = user_location,
         source_sudeshna = source_location) %>% 
  select(row_id_new,sentence,locations,source_sudeshna,user_sudeshna)

#combined_data_clean
combined_df_clean <- left_join(raw_annotation_data_sudeshna,drew_merge_data, by = "row_id_new")


```

# Interrater kappas 


```{r create-users-data-and-kappa}
# Users df
users_sudeshna <- raw_annotation_data_sudeshna %>% 
  select(row_id_new,user_sudeshna)
users_drew <- drew_data %>% 
  select(row_id_new,user_drew)

#Join
combined_users <- left_join(users_sudeshna,users_drew, by = "row_id_new") %>% 
  select(user_drew,user_sudeshna)

user_location_kappa <- irr::kappa2(combined_users)
user_location_kappa

```

```{r create-source-location-data-and-kappa}
# Source location df
source_sudeshna <- raw_annotation_data_sudeshna %>% 
  select(row_id_new,source_sudeshna)
source_drew <- drew_data %>% 
  select(row_id_new,source_drew)

#Join
combined_locations <- left_join(source_sudeshna,source_drew, by = "row_id_new") %>% 
  select(source_drew,source_sudeshna)

source_location_kappa <- irr::kappa2(combined_locations)
source_location_kappa

```


# ID Disagreements 

```{r}
combined_location_user_df_clean <- combined_df_clean %>% 
  mutate(user_agree = case_when(user_drew==user_sudeshna~1, TRUE~0),
         source_agree = case_when(source_drew==source_sudeshna~1,TRUE~0))
table(combined_location_user_df_clean$user_agree) 
table(combined_location_user_df_clean$source_agree)

source_disagreements <- combined_location_user_df_clean %>% 
  filter(source_agree == 0)
gt(source_disagreements) %>% 
  tab_header("Source Disagreements")%>% 
  gtsave("Source_disagreements.html", inline_css = TRUE, 
         path = here())


user_disagreements <- combined_location_user_df_clean %>% 
  filter(user_agree == 0)
gt(user_disagreements) %>% 
  tab_header("User Disagreements")%>% 
  gtsave("user_disagreements.html", inline_css = TRUE, 
         path = here())

agreements <- combined_location_user_df_clean %>% 
  filter(user_agree == 1& source_agree ==1) %>% 
  mutate(source_location_label = source_drew,
         user_location_label = user_drew)


disagreements <- rbind(user_disagreements,source_disagreements) %>% 
  distinct(row_id_new, .keep_all = TRUE) %>% 
  mutate(source_location_label= "",
         user_location_label = "")
write_csv(disagreements, "disagreements_to_adjudicate.csv")


adjudications <- read_csv("adjudications_sn_locations.csv")
```

# Adjudications


